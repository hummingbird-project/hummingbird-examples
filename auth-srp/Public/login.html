<!DOCTYPE html>
<html>
<head>
    <title>SRP Login Test</title>
    <meta charset="UTF-8">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script type="text/javascript" src="js/jsbn.js"></script>
    <script type="text/javascript" src="js/sha1.js"></script>
    <script type="text/javascript" src="js/sjcl.js"></script>
    <script type="text/javascript" src="js/srp-client.js"></script>

    <script type="text/javascript">

        function bignum(event) {
            let b = new BigInteger("1000000000000", 256)
            console.log(b.toString())
            let verifyData = {
                "num": btoa(b)
            }
            $.ajax({
                url: '/api/user/bignum',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(verifyData),
                dataType: 'json',
                processData: false,
                success: function(data) {
                    console.log(data)
                    alert("Login success")
                },
                error: function(data) {
                    alert("Login failed")
                }
            })

        }

        function login(event) {
            event.preventDefault();

            var bits     =  2048;
            var username = $("#name").val();
            var password = $("#password").val();

            var srp = new SRPClient(username, password, 2048);

              // 1. The client generates and stores A.
              var a = srp.srpRandom();
              var A = srp.calculateA(a);

              // 2. The client sends A to the server.
              let data = {
                  "A": btoa(A),
                  "name": username
              }
              console.log("Input: " + JSON.stringify(data))
              $.ajax({
                  url: '/api/user/login',
                  type: 'POST',
                  contentType: 'application/json',
                  data: JSON.stringify(data),
                  dataType: 'json',
                  processData: false,
                  success: function(data) {
                      console.log(data)
                      var B = BigInteger(atob(data.B))
                      var salt = data.salt
                      // 4. The client and the server both calculate U.
                      var u = srp.calculateU(A, B)

                      // 5. The client generates its premaster secret.
                      var Sc = srp.calculateS(B, salt, u, a);

                      // 2. The client sends A to the server.
                      let verifyData = {
                          "proof": btoa(Sc),
                          "sessionId": data.sessionId
                      }
                      $.ajax({
                          url: '/api/user/verify',
                          type: 'POST',
                          contentType: 'application/json',
                          data: JSON.stringify(verifyData),
                          dataType: 'json',
                          processData: false,
                          success: function(data) {
                              console.log(data)
                              alert("Login success")
                          },
                          error: function(data) {
                              alert("Login failed")
                          }
                      })

                  },
                  error: function(data) {
                      alert("Login failed")
                  }
              })
        }
    </script>
</head>
<body>
    <h1>Login</h1>
    <form action="#">
    <label for="name">Name</label><br/>
    <input type="text" id="name" name="name"/><br/>
    <label for="password">Password</label><br/>
    <input type="text" id="password" name="password"/><br/>
    <br>
    <input type="submit" value="Submit" onclick="bignum(event)"/>
    </form>
</body>
</html>
